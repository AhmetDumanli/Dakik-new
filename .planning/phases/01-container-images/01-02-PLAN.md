---
phase: 01-container-images
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - frontend/Dockerfile
  - frontend/.dockerignore
  - frontend/nginx.conf
autonomous: true

must_haves:
  truths:
    - "React frontend builds into a Docker image without errors"
    - "Docker image uses multi-stage build (node build + nginx runtime)"
    - "Docker image excludes build artifacts via .dockerignore"
    - "Final image is optimized (under 50MB)"
    - "nginx serves React SPA with proper routing configuration"
  artifacts:
    - path: "frontend/Dockerfile"
      provides: "Multi-stage Docker build for React frontend"
      contains: "FROM node:20-alpine AS builder"
    - path: "frontend/.dockerignore"
      provides: "Build context exclusions"
      contains: "node_modules/"
    - path: "frontend/nginx.conf"
      provides: "nginx configuration for SPA routing"
      contains: "try_files $uri $uri/ /index.html"
  key_links:
    - from: "frontend/Dockerfile"
      to: "frontend/nginx.conf"
      via: "COPY nginx.conf in runtime stage"
      pattern: "COPY nginx.conf /etc/nginx/conf.d/default.conf"
    - from: "frontend/nginx.conf"
      to: "React Router"
      via: "SPA routing fallback to index.html"
      pattern: "try_files .* /index.html"
---

<objective>
Create optimized Docker image for React 19 frontend using multi-stage build with Node.js builder and nginx Alpine runtime.

Purpose: Enable containerization of the frontend with production-ready static asset serving, SPA routing support, and security headers. This completes Phase 1 by containerizing all application components.

Output: Frontend will have Dockerfile, .dockerignore, and nginx.conf, allowing it to be built as a standalone Docker image (~30MB) serving production React build with nginx.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-container-images/01-RESEARCH.md

Frontend details:
- React 19.2.0
- Vite 7.2.4
- react-router-dom 7.13.0
- Port: 5173 (dev), 80 (production nginx)
- Build command: npm run build
- Output: dist/
</context>

<tasks>

<task type="auto">
  <name>Create nginx.conf for React SPA routing</name>
  <files>frontend/nginx.conf</files>
  <action>
Create nginx.conf with production-ready configuration for React SPA.

Use the exact pattern from RESEARCH.md "Production-Ready nginx.conf for React SPA" which includes:

1. Server block:
   - listen 80
   - server_name _
   - server_tokens off (hide nginx version)
   - root /usr/share/nginx/html
   - index index.html

2. SPA routing location block:
   - location /
   - try_files $uri $uri/ /index.html
   (This is critical - handles React Router client-side routing)

3. Static asset caching:
   - location for .js, .css, .png, .jpg, .jpeg, .gif, .ico, .svg, .woff, .woff2, .ttf, .eot
   - expires 1y
   - Cache-Control "public, immutable"

4. Security headers (with "always" parameter for 4xx/5xx responses):
   - X-Content-Type-Options "nosniff"
   - X-Frame-Options "DENY"
   - X-XSS-Protection "1; mode=block"
   - Referrer-Policy "no-referrer-when-downgrade"

5. Gzip compression:
   - gzip on
   - gzip_vary on
   - gzip_types for text/plain, text/css, application/json, application/javascript, text/xml, application/xml, text/javascript

This configuration ensures React Router routes work when directly accessed or refreshed, static assets are cached, and security headers are present.

Create this file BEFORE the Dockerfile so the Dockerfile can reference it.
  </action>
  <verify>
# Verify nginx.conf exists and contains key patterns
cat frontend/nginx.conf | grep "try_files"
cat frontend/nginx.conf | grep "server_tokens off"
cat frontend/nginx.conf | grep "add_header.*always"
  </verify>
  <done>
frontend/nginx.conf exists with SPA routing (try_files), security headers (with always flag), and gzip compression configured.
  </done>
</task>

<task type="auto">
  <name>Create Dockerfile for React frontend</name>
  <files>frontend/Dockerfile</files>
  <action>
Create multi-stage Dockerfile for React frontend with Vite build and nginx serving.

Use the exact pattern from RESEARCH.md "Complete React/Vite Multi-Stage Dockerfile":

1. Build stage:
   - Base: node:20-alpine AS builder
   - Workdir: /app
   - Copy package.json and package-lock.json first (dependency caching)
   - Run npm ci --only=production (faster than npm install)
   - Copy rest of application (. .)
   - Run npm run build (creates dist/)

2. Runtime stage:
   - Base: nginx:alpine
   - Copy build artifacts: COPY --from=builder /app/dist /usr/share/nginx/html
   - Copy nginx config: COPY nginx.conf /etc/nginx/conf.d/default.conf
   - Expose 80
   - User nginx (run as non-root)
   - CMD ["nginx", "-g", "daemon off;"]

This pattern achieves ~30MB final image (nginx:alpine ~20MB + React build assets).

Key ordering for caching:
1. Copy package files -> npm ci (changes rarely)
2. Copy source -> npm run build (changes frequently)
3. Only dist/ copied to runtime stage

Do NOT add EXPOSE in this Dockerfile since we're using nginx (nginx:alpine already handles this). Actually, DO add EXPOSE 80 for documentation.
  </action>
  <verify>
docker build -t frontend:test ./frontend

# Verify build completes
docker images | grep frontend:test

# Verify nginx.conf is present in image
docker run --rm frontend:test cat /etc/nginx/conf.d/default.conf | grep "try_files"
  </verify>
  <done>
frontend/Dockerfile exists. docker build completes successfully. Image is under 50MB. nginx.conf is correctly copied into the image. Runtime stage uses nginx:alpine base.
  </done>
</task>

<task type="auto">
  <name>Create .dockerignore for frontend</name>
  <files>frontend/.dockerignore</files>
  <action>
Create .dockerignore file for frontend to exclude unnecessary files from build context.

Use the exact pattern from RESEARCH.md "Frontend .dockerignore":

Dependencies:
- node_modules/

Build outputs:
- dist/
- build/
- .vite/

IDE files:
- .idea/
- .vscode/
- *.swp

OS files:
- .DS_Store
- Thumbs.db

Git:
- .git/
- .gitignore

Secrets and environment:
- .env
- .env.*
- .npmrc (may contain auth tokens)

Test and coverage:
- coverage/
- .nyc_output/

Documentation:
- README.md
- LICENSE
- *.md

Logs:
- npm-debug.log*
- yarn-debug.log*
- yarn-error.log*

This reduces build context from 100s MB (node_modules/) to under 10MB and prevents secrets (.env, .npmrc) from being copied into the image.
  </action>
  <verify>
# Verify .dockerignore exists
ls -la frontend/.dockerignore

# Verify build context respects .dockerignore
docker build --no-cache -t test-frontend ./frontend 2>&1 | grep -i "sending build context"
# Should show small context size (<10MB)
  </verify>
  <done>
frontend/.dockerignore exists. Build context size is under 10MB. node_modules/, dist/, and .env files are excluded.
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Build frontend image:
```bash
docker build -t dakik/frontend:latest ./frontend
```

2. Verify image size (should be under 50MB):
```bash
docker images | grep dakik/frontend
```

3. Verify nginx.conf is in the image:
```bash
docker run --rm dakik/frontend:latest cat /etc/nginx/conf.d/default.conf
```

4. Test that nginx serves index.html (basic smoke test):
```bash
docker run --rm -d -p 8888:80 --name test-frontend dakik/frontend:latest
curl http://localhost:8888/
docker stop test-frontend
# Should return index.html content
```

5. Verify SPA routing config exists:
```bash
docker run --rm dakik/frontend:latest cat /etc/nginx/conf.d/default.conf | grep "try_files"
# Should contain: try_files $uri $uri/ /index.html;
```
</verification>

<success_criteria>
1. frontend/Dockerfile, frontend/.dockerignore, and frontend/nginx.conf exist
2. docker build succeeds for frontend
3. Final image is optimized (under 50MB)
4. Multi-stage build is used (node:20-alpine build + nginx:alpine runtime)
5. nginx.conf is correctly copied into the image
6. SPA routing is configured (try_files fallback to index.html)
7. Security headers are present in nginx.conf
8. Build artifacts (node_modules/, dist/) are excluded via .dockerignore
9. Sensitive files (.env, .npmrc) are excluded via .dockerignore
</success_criteria>

<output>
After completion, create `.planning/phases/01-container-images/01-02-SUMMARY.md` with:
- Files created (3 files: Dockerfile, .dockerignore, nginx.conf)
- Image size
- Build time
- nginx configuration highlights
- Any issues encountered and resolutions
</output>
